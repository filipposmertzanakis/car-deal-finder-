name: Car Scraping with Undetected Chromedriver

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:          # Allow manual triggers

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 30       # Prevent hanging jobs

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Verify script exists
      run: |
        if [ ! -f "new_workflow/scrape_with_score.py" ]; then
          echo "âŒ Error: Script not found!"
          exit 1
        fi
        echo "âœ… Script found"

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          unzip \
          libnss3-dev \
          libgbm-dev \
          libxss1 \
          libappindicator3-1 \
          fonts-liberation \
          libnspr4 \
          libnss3 \
          libx11-xcb1 \
          libxtst6 \
          libxrandr2 \
          libasound2-dev \
          libpangocairo-1.0-0 \
          libatk1.0-0 \
          libcairo-gobject2 \
          libgtk-3-0 \
          libgdk-pixbuf2.0-0

    - name: Setup Chrome and Chromedriver
      run: |
        echo "â¬‡ï¸ Installing Chrome..."
        
        # Install Chrome via apt (more reliable)
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Get Chrome version
        CHROME_VERSION=$(google-chrome --version | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+')
        CHROME_MAJOR_VERSION=$(echo $CHROME_VERSION | cut -d. -f1)
        echo "Chrome version: $CHROME_VERSION (Major: $CHROME_MAJOR_VERSION)"
        
        # Download ChromeDriver using the Chrome for Testing API
        echo "â¬‡ï¸ Downloading matching ChromeDriver..."
        
        # First try exact version match
        CHROMEDRIVER_URL="https://storage.googleapis.com/chrome-for-testing-public/${CHROME_VERSION}/linux64/chromedriver-linux64.zip"
        echo "Trying exact version: $CHROMEDRIVER_URL"
        
        if wget -q --spider "$CHROMEDRIVER_URL"; then
          echo "âœ… Found exact version match"
          wget -O chromedriver.zip "$CHROMEDRIVER_URL"
        else
          echo "âŒ Exact version not found, trying latest stable for major version $CHROME_MAJOR_VERSION..."
          
          # Get latest version for this major version
          LATEST_VERSIONS_URL="https://googlechromelabs.github.io/chrome-for-testing/latest-versions-per-milestone.json"
          LATEST_VERSION=$(curl -s "$LATEST_VERSIONS_URL" | grep -o "\"$CHROME_MAJOR_VERSION\":{\"version\":\"[^\"]*\"" | cut -d'"' -f4)
          
          if [ -n "$LATEST_VERSION" ]; then
            CHROMEDRIVER_URL="https://storage.googleapis.com/chrome-for-testing-public/${LATEST_VERSION}/linux64/chromedriver-linux64.zip"
            echo "Trying latest stable: $CHROMEDRIVER_URL"
            wget -O chromedriver.zip "$CHROMEDRIVER_URL"
          else
            echo "âŒ Could not find ChromeDriver for major version $CHROME_MAJOR_VERSION"
            echo "ðŸ“¦ Installing ChromeDriver via apt as fallback..."
            sudo apt-get install -y chromium-chromedriver
            sudo chmod 755 /usr/bin/chromedriver
            sudo ln -sf /usr/bin/chromedriver /usr/local/bin/chromedriver
            echo "âœ… ChromeDriver installed via apt"
            exit 0
          fi
        fi
        
        # Extract and install ChromeDriver
        unzip chromedriver.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/
        sudo chmod 755 /usr/local/bin/chromedriver
        sudo chown root:root /usr/local/bin/chromedriver
        
        # Create Chrome symlink for compatibility
        sudo ln -sf /usr/bin/google-chrome /usr/local/bin/google-chrome
        
        echo "âœ… Installed versions:"
        google-chrome --version
        chromedriver --version
        
        # Test Chrome startup
        echo "ðŸ§ª Testing Chrome startup..."
        timeout 10s google-chrome --headless --no-sandbox --disable-gpu --dump-dom https://www.google.com > /dev/null && echo "âœ… Chrome test passed" || echo "âš ï¸ Chrome test completed with warnings"

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install undetected-chromedriver requests beautifulsoup4 selenium supabase python-dotenv

    - name: Run scraping script
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        EMAIL_HOST: ${{ secrets.EMAIL_HOST }}
        EMAIL_PORT: ${{ secrets.EMAIL_PORT }}
        EMAIL_USER: ${{ secrets.EMAIL_USER }}
        EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
      run: |
        # Enable debug logging
        export DEBUG=1
        python -u new_workflow/scrape_with_score.py 2>&1 | tee scrape.log
        echo "=== Scrape log ==="
        cat scrape.log
        echo "=================="

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: scrape-logs
        path: scrape.log